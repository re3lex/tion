"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("axios")),i=t(require("querystring"));module.exports=class{constructor(t){this.email=t.email,this.password=t.password,this.authorization=t.authKey,this.minUpdateInterval=t.minUpdateIntervalSec||10,this.lastUpdate=0}doAuthorization(){if(this.authorization)return Promise.resolve(this.authorization);const t={username:this.email,password:this.password,client_id:"cd594955-f5ba-4c20-9583-5990bb29f4ef",client_secret:"syRxSrT77P",grant_type:"password"};return e.post("https://api2.magicair.tion.ru/idsrv/oauth2/token",i.stringify(t),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(t=>{const{status:e,data:i}=t;if(200===e){const{token_type:t,access_token:e}=i;return this.authorization=`${t} ${e}`,this.authorization}return console.error("Error on getting token",t),Promise.reject(new Error("Error on getting token"))}).catch(t=>{throw console.error("Error on getting token",t),t})}getHeaders(){return{Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate","Accept-Language":"ru-RU",Authorization:this.authorization,Connection:"Keep-Alive","Content-Type":"application/json",Host:"api2.magicair.tion.ru",Origin:"https://magicair.tion.ru",Referer:"https://magicair.tion.ru/dashboard/overview","User-Agent":"Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10586"}}getData(t){const{minUpdateInterval:i,lastUpdate:r}=this;return!t&&(new Date).valueOf()-r<i?Promise.resolve(this.data):this.authorization?(this.data=void 0,e.get("https://api2.magicair.tion.ru/location",{headers:this.getHeaders()}).then(t=>{const{status:e,data:i}=t;if(200===e)return[this.data]=i,this.lastUpdate=(new Date).valueOf(),Promise.resolve(this.data);if(401===e)return console.warn("Authorization is required"),this.authorization=void 0,this.doAuthorization().then(t=>t?this.getData():(console.error("Authorization failed!"),Promise.reject(new Error("Authorization failed!"))));const r=`Status code while getting data is ${e}, content:\n ${JSON.stringify(i)}!`;return console.error(r),Promise.reject(new Error(`Status code while getting data is ${e}`))})):this.doAuthorization().then(t=>t?this.getData():(console.error("Authorization failed!"),Promise.reject(new Error("Authorization failed!"))))}getZones({names:t=[],guids:e=[]}){return this.getData().then(i=>{const{zones:r=[]}=i;return r.filter(i=>e.indexOf(i.guid)>=0||t.indexOf(i.name)>=0)})}getDevices({names:t=[],guids:e=[],types:i=[]}){return this.getData().then(r=>{const{zones:o=[]}=r,a=[];return o.forEach(r=>{const o=r.devices.filter(r=>e.indexOf(r.guid)>=0||t.indexOf(r.name)>=0||i.indexOf(r.type)>=0);a.push(...o)}),a})}};
